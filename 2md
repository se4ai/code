#!/usr/bin/env bash

# todo. add yaml front matter include "code: true"

Top=$(git rev-parse --show-toplevel)

There=$Top/../web
Url="https://github.com/se4ai/code/tree/master"

md2md() {
  cat $1 | gawk '
  /^# /{ sub(/^#/,"")
        print "---"
        print "title: \"" $0 "\""
        print "layout: default"
        print "---"
        next
      }
  1 '
} 
py2md() {
  url="$2"
  file="$1"
  cat $file | gawk 'BEGIN {  
         q="\""
         print ""
         First = 1      
         In = 1
  }         
  /^# /{ sub(/^#/,"")
        print "---"
        print "title: \"" $0 "\""
        print "layout: default"
        print "code: true"
        print "---"
        print ""
        print "Read the code on [Github]('$url') <font color=orange><i class=\"fab fa-github-3x\"></i></font>."
        print ""
      }
  /^"""</,/^>"""/ {  next } 
  /^"""/          {  In = 1 - In       
                     if (In)            
                       print "````python"
                     else          
                       if (First)   
                         First = 0   
                       else     
                         print "````"  
                     next }       
  ! First { print (In ? sprintf("%4s. ",++n) : "") $0 }       
  END     { if (In) print "````"
            }'
} 
AFTER=true
main() {
  com=$2
  arg=$1
  file=$(basename $arg)
  stem="${file%%.*}"
  out=$There/${stem}.md
  if [ "$1" -nt "$out" ]; then
    echo "# $(basename $arg) ==> $out"
    $com $1 $Url/$file > $out
    (cd $There; git add $out)
    AFTER=finish
  fi
}

finish() {
  cd $There
  git commit -am as
  git push
}

mkdir -p $There/img

cd $Top
for f in $(diff -q img $There/img | gawk '{print $(NF-1)}'); do
  g=$(basename $f)
  echo "adding $g"
  cp img/$g $There/img/$g
  AFTER=finish
done 

for f in src/*.py; do main $f py2md ; done
for f in src/*.md; do main $f md2md ; done

$AFTER
